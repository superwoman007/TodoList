# TodoList Nginx 配置 (HTTPS + 自签名 CA)
# 将此文件复制到 /etc/nginx/sites-available/todolist
# 然后创建软链接: sudo ln -s /etc/nginx/sites-available/todolist /etc/nginx/sites-enabled/

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name 111.230.56.116;

    # CA 证书下载（HTTP 也可访问，方便首次安装）
    location /certs/ {
        alias /var/www/todolist/apps/web/certs/;
        default_type application/x-x509-ca-cert;
        add_header Content-Disposition 'attachment; filename="TodoList-CA.crt"';
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS 服务器
server {
    listen 443 ssl;
    server_name 111.230.56.116;

    # SSL 证书配置（由自建 CA 签发）
    ssl_certificate /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;
    
    # SSL 安全设置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;

    # CA 证书下载端点（手机浏览器访问此地址安装根证书）
    location /certs/ {
        alias /var/www/todolist/apps/web/certs/;
        default_type application/x-x509-ca-cert;
        add_header Content-Disposition 'attachment; filename="TodoList-CA.crt"';
    }

    # 前端静态文件
    location / {
        root /var/www/todolist/apps/web;
        index index.html;
        try_files $uri $uri/ /index.html;

        # Capacitor WebView 需要的 CORS 头
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # API 代理（CORS 由 FastAPI 中间件统一处理，nginx 不再重复添加）
    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 健康检查端点
    location /health {
        proxy_pass http://127.0.0.1:8000/health;
        proxy_set_header Host $host;
    }

    # 兼容路由：当前端 _apiHost 为空时，请求会直接到 /auth/、/todos/ 等路径
    # 将这些 API 路径也代理到后端，避免 405 错误
    location /auth/ {
        proxy_pass http://127.0.0.1:8000/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /todos {
        proxy_pass http://127.0.0.1:8000/todos;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /tags {
        proxy_pass http://127.0.0.1:8000/tags;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /scene-templates {
        proxy_pass http://127.0.0.1:8000/scene-templates;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
